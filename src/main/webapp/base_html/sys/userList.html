<!DOCTYPE html>
<head>
    <!-- Meta -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="renderer" content="webkit">
    <title>翰维前端框架</title>

    <!-- CSS文件 -->
    <link href="../../base_ui/css/bootstrap.min.css" rel="stylesheet">
    <link href="../../base_ui/css/font-awesome.css" rel="stylesheet">
    <link href="../../base_ui/css/animate.css" rel="stylesheet">
    <link href="../../base_ui/css/style.css" rel="stylesheet">

    <link href="../../base_ui/css/codemirror.css" rel="stylesheet">
</head>
<body>
<div id="page-center" class="wrapper wrapper-content animated fadeInRight">
    <div class="row">
        <div class="col-lg-12">
            <div id="box"></div>
        </div>
    </div>
</div>

<script src="../../base_ui/js/jquery-1.11.1.min.js"></script>
<script src="../../base_ui/js/bootstrap.min.js"></script>
<script src="../../base_ui/js/jquery.validate.js"></script>
<script src="../../base_ui/js/hitworth.form.js"></script>
<script src="../../base_ui/js/hitworth.grid.js"></script>
<script src="../../base_ui/js/hitworth.box.js"></script>
<script src="../../base_ui/js/hitworth.modal.js"></script>

<script src="../../base_ui/js/codemirror/codemirror.js"></script>
<script src="../../base_ui/js/codemirror/javascript.js"></script>
<script src="../../base_ui/js/hitworth.bootbox.js"> </script>

<link href="../../base_ui/css/zTreeStyle.css" rel="stylesheet">

<script src="../../base_ui/js/jquery.ztree.core-3.5.min.js"> </script>
<script src="../../base_ui/js/jquery.ztree.excheck-3.5.min.js"> </script>
<script src="../../base_ui/js/hitworth.tree.js"> </script>
<script>
    // ***********js写在这里****************************
    //第一步 生成grid所在的表格
    var box = $("#box").HwBox({
        title : "用户列表",
        close : false,
        collapse : false
    });

    //grid的参数设置
    var options = {
        url : "../../user/list.do", // ajax地址
        pageNum : 1,//当前页码
        pageSize : 15,//每页显示条数
        id_filed : "id",//id域指定
        show_check : true,//是否显示checkbox
        cloums : [
            {title: "账号", filed: "loginName",width : "15%"},
            {title: "姓名", filed: "displayName"},
            {title: "用户类型", filed: "type", format: typeFormatData},
            {title: "用户状态", filed: "state", format: stateFormatData},
            {title: "邮箱", filed: "email"},
            {title: "电话", filed: "contactPhone"}],
        //操作栏
        actionCloumText : "操作",
        actionCloums : [ {
            text : "删除",
            cls:"mgr-3",
            handle : function(index, data) {
                var url = "../../user/delete.do";
                bootbox.confirm("确定删除吗？", function (result) {
                    if (result) {
                        $.post(url, {
                            id: data.id,
                            loginName: data.loginName
                        }, function (res) {
                            if (res.result == true) {
                                bootbox.alert("删除成功");
                                grid1._refresh();
                            } else {
                                bootbox.alert("删除失败:" + res.err);
                            }
                        });
                    }
                });
            }
        },{
            textHandle : function(index, data){
                return "编辑";
            },
            cls:"mgr-3",
            handle : function(index, data) {
                //$("#example_form").loadUrl("jsp/load_form.jsp");
                form.reset();
                form.loadLocal(data);
                form._form_action = "../../user/update.do?id=" + data.id;
                modal.setTitle("修改用户");
                $('#loginName').attr("readonly", true);
                $('#modal1').modal('show');
            }
        }, {
            text: "冻结",
            cls:"mgr-3",
            textHandle: function (index, data) {
                if (data.state == 1) {
                    return "冻结";
                } else {
                    return "解冻";
                }
            },
            handle: function (index, data) {
                var url = "../../user/frozen.do";
                $.post(url, {
                    id: data.id,
                    state: data.state
                }, function (res) {
                    if (res.result == true) {
                        alert("操作成功");
                        grid1._refresh();
                    } else {
                        alert("操作失败");
                    }
                });
            }
        }, {
            text: "分配角色",
            cls:"mgr-3",
            handle: function (index, data) {
                //生成弹出框
                var treeModal = $("body").HwModal({
                    title: "角色",
                    showOkButton: true,//是否显示确认按钮
                    okButtonText: "确认",//确认按钮显示文本
                    okHandle: function () {
                        var zTree = $.fn.zTree.getZTreeObj("roleTree");
                        var nodes = zTree.getCheckedNodes(true);
                        var nodeIds = [];
                        for (var i in nodes) {
                            nodeIds.push(nodes[i].id);
                        }
                        var url = "../../user/checkRoles.do";
                        $.post(url, {
                            id: data.id,
                            roleIds: nodeIds.toString()
                        }, function (res) {
                            if (res.result == true) {
                                alert("操作成功");
                                grid1.reload();
                            } else {
                                alert("操作失败");
                            }
                        });
                    }
                    //点击按钮事件
                });
                //生成树
                var setting = {
                    check: {
                        enable: true
                    },
                    data: {
                        simpleData: {
                            enable: true
                        }
                    }
                };
                treeModal.$body.HwTree({
                    setting: setting,
                    url: "../../user/roleList.do?id=" + data.id,
                    treeId: "roleTree"
                });
                treeModal.show();
            }
        }, {
            text: "分配组织机构",
            cls:"mgr-3",
            handle: function (index, data) {
                //生成弹出框
                var orgTreeModal = $("body").HwModal({
                    title: "组织机构",
                    showOkButton: true,//是否显示确认按钮
                    okButtonText: "确认",//确认按钮显示文本
                    okHandle: function () {
                        var zTree = $.fn.zTree.getZTreeObj("orgTree");
                        var nodes = zTree.getCheckedNodes(true);
                        var nodeIds = [];
                        for (var i in nodes) {
                            nodeIds.push(nodes[i].id);
                        }
                        url = "../../user/selectOrg.do";
                        $.post(url, {
                            userId: data.id,
                            orgId: nodeIds.toString()
                        }, function (res) {
                            if (res.result == true) {
                                alert("操作成功");
                                grid1.reload();
                            } else {
                                alert("操作失败");
                            }
                        });
                    }
                    //点击按钮事件
                });
                //生成树
                var setting = {
                    check: {
                        enable: true,
                        chkStyle: "radio",
                        radioType: "all"
                    },
                    data: {
                        simpleData: {
                            enable: true
                        }
                    }
                };
                orgTreeModal.$body.HwTree({
                    setting: setting,
                    url: "../../user/orgTree.do?userId=" + data.id,
                    treeId: "orgTree"
                });
                orgTreeModal.show();
            }
        }],
        //第一行的工具栏
        tools : [
            //工具属性
            {
                text : "添加",//按钮文本
                cls : "btn-primary",//按钮样式
                handle : function() {//按钮点击事件
                    form.reset();
                    modal.setTitle("新增用户");
                    form._form_action = "../../user/add.do";
                    $('#loginName').attr("readonly", false);
                    $('#modal1').modal('show');
                }
            }, {
                text : "刷新",
                cls : "btn-danger",//按钮样式
                handle : function() {
                    grid1.reload({
                        pageNum : 1
                    });
                }
            } ],
        //搜索栏定义
        search: {
            //搜索栏元素
            items: [{
                type: "text",
                label: "账号",
                name: "loginName"
            }, {
                type: "text",
                label: "姓名",
                name: "displayName"
            }]
        }
    };
    //生成grid代码
    var grid1 = box.$content.HwGrid(options);
    //form设置
    var formOpts = {
        id : "example_form",//表单id
        name : "example_form",//表单名
        method : "post",//表单method
        action : "../../user/add.do",//表单action
        ajaxSubmit : true,//是否使用ajax提交表单
        isValidate : true,
        ajaxSuccess : function(data){
            if (data.result) {
                bootbox.alert("保存成功");
                grid1._refresh();
                $('#modal1').modal('hide');
            } else {
                bootbox.alert(data.err);
                //form.alertText("warning", data.err, 2000);
            }
        }, //如果用ajax，则该项为必须
        submitText : "保存",//保存按钮的文本
        //showReset : true,//是否显示重置按钮
        //resetText : "重置",//重置按钮文本
        /*buttons : [ {
         type : 'button',
         text : '异步加载',
         handle : function() {
         $("#example_form").HwLoadForm("jsp/load_form.jsp");
         }
         } ],//额外的按钮自定义*/
        //表单元素
        //表单元素
        isValidate: true,//开启验证
        items: [
            {
            type: 'text',
            name: 'loginName',
            id: 'loginName',
            label: '账号',
            span: '4',
            rule: {
                required: "true",
                rangelength: "[5,15]"
            },
            msg: {
                required: "账号不能为空",
                rangelength: "账号长度5~15位"
            }

        }, {
            type: 'password',
            name: 'password',
            id: 'password',
            label: '密码',
            span: '4',
            rule: {
                required: "true",
                maxlength: "20"
            },
            msg: {
                required: "密码不能为空",
                maxlength: "最大长度20位"
            }
        }, {
            type: 'password',
            name: 'prePassword',
            id: 'prePpassword',
            label: '确认密码',
            span: '4',
            rule: {
                required: "true",
                equalTo: "#password"
            },
            msg: {
                required: "密码不能为空",
                equalTo: "两次密码不一致"
            }
        }, {
            type: 'text',
            name: 'displayName',
            id: 'displayName',
            label: '姓名',
            span: '4',
            rule: {
                required: "true",
                maxlength: "20"
            },
            msg: {
                required: "姓名不能为空",
                maxlength: "最大长度20位"
            }
        }, {
            type: 'select',
            name: 'type',
            id: 'type',
            label: '用户类型',
            span: '4',
            items: [{
                value: 'normal',
                text: '普通用户'
            }, {
                value: 'ca',
                text: 'CA用户'
            }]
        }, {
            type: 'text',
            name: 'email',
            id: 'email',
            label: '邮箱',
            span: '8',
            rule: {
                required: "true",
                email: "true"
            },
            msg: {
                required: "邮箱不能为空",
                email: "邮箱格式不正确"
            }
        }, {
            type: 'text',
            name: 'contactPhone',
            id: 'contactPhone',
            label: '手机号',
            span: '4',
            rule: {
                required: "true",
                maxlength: "11",
                minlength: "11",
                digits: "true"
            },
            msg: {
                required: "请输入11位手机号",
                maxlength: "请输入11位手机号",
                minlength: "请输入11位手机号",
                digits: "请输入11位手机号"
            }
        }]
    };
    //生成弹出层
    var modal = $("body").HwModal({
        id : "modal1",
        title : "表单"
    });
    //生成表单并插入弹出层
    var form = modal.$body.HwForm(formOpts);

    function typeFormatData(index, content) {
        if (content.type == "ca") {
            return "CA用户";
        } else {
            return "普通用户";
        }
    }

    function stateFormatData(index, content) {
        if (content.state == 1) {
            return "正常";
        } else {
            return "已冻结";
        }
    }
</script>
</body>
</html>