<!DOCTYPE html>
<head>
	<!-- Meta -->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="renderer" content="webkit">
	<title>翰维前端框架</title>

	<!-- CSS文件 -->
	<link href="../../base_ui/css/bootstrap.min.css" rel="stylesheet">
	<link href="../../base_ui/css/font-awesome.css" rel="stylesheet">
	<link href="../../base_ui/css/animate.css" rel="stylesheet">
	<link href="../../base_ui/css/style.css" rel="stylesheet">

	<link href="../../base_ui/css/codemirror.css" rel="stylesheet">
</head>
<body>
<div id="page-center" class="wrapper wrapper-content animated fadeInRight">
	<div class="row">
		<div class="col-lg-12">
			<div id="box"></div>
		</div>
	</div>
</div>

<script src="../../base_ui/js/jquery-1.11.1.min.js"></script>
<script src="../../base_ui/js/bootstrap.min.js"></script>
<script src="../../base_ui/js/jquery.validate.js"></script>
<script src="../../base_ui/js/hitworth.form.js"></script>
<script src="../../base_ui/js/hitworth.grid.js"></script>
<script src="../../base_ui/js/hitworth.box.js"></script>
<script src="../../base_ui/js/hitworth.modal.js"></script>

<script src="../../base_ui/js/codemirror/codemirror.js"></script>
<script src="../../base_ui/js/codemirror/javascript.js"></script>
<script src="../../base_ui/js/hitworth.bootbox.js"> </script>

<link href="../../base_ui/css/zTreeStyle.css" rel="stylesheet">

<script src="../../base_ui/js/jquery.ztree.core-3.5.min.js"> </script>
<script src="../../base_ui/js/jquery.ztree.excheck-3.5.min.js"> </script>
<script src="../../base_ui/js/hitworth.tree.js"> </script>
<script>
	// ***********js写在这里****************************
	//第一步 生成grid所在的表格
	var box = $("#box").HwBox({
		title : "角色列表",
		close : false,
		collapse : false
	});

	//grid的参数设置
	var options = {
		url : '../../role/list.do', // ajax地址
		pageNum : 1,//当前页码
		pageSize : 15,//每页显示条数
		id_filed : "id",//id域指定
		show_check : true,//是否显示checkbox
		cloums : [ {
			title : "角色名称",
			filed : "roleName"
		}, {
			title : "角色状态",
			filed : "state",
			format : stateFormatData
		}, ],
		//操作栏
		actionCloumText : "操作",
		actionCloums : [
			{
				text : "删除",
				cls:"mgr-3",
				handle : function(index, data) {
					url = "../../role/delete.do";
					bootbox.confirm("确定删除吗？",function(result){
						if(result){
							$.post(url, {
								id : data.id
							}, function(data) {
								if (data.result == true) {
									bootbox.alert("删除成功");
									grid1.reload();
								} else {
									bootbox.alert("删除失败"+data.err);
								}
							});
						}
					});
				}
			},{
				text : "编辑",
				cls:"mgr-3",
				handle : function(index, data) {
					form.reset();
					form.loadRemote("../../role/view.do?id=" + data.id);
					form._form_action = "../../role/update.do?id=" + data.id;
					$('#modal1').modal('show');
				}
			},{
				textHandle : function(index, data) {
					if (data.state == 0) {
						return "启用";
					} else {
						return "关闭";
					}
				},
				cls:"mgr-3",
				handle : function(index, data) {
					url = "../../role/updateState.do";
					$.post(url, {
						id : data.id,
						state : data.state
					}, function(data) {
						if (data.result == true) {
							bootbox.alert("操作成功");
							grid1.reload();
						} else {
							bootbox.alert("操作失败");
						}
					});
				}
			},{
				text : "分配功能",
				cls:"mgr-3",
				handle : function(index, data) {
					//生成弹出框
					var modal = $("body").HwModal({
						title : "功能选择",
						showOkButton : true,//是否显示确认按钮
						okButtonText : "确认",//确认按钮显示文本
						okHandle : function() {
							var zTree = $.fn.zTree.getZTreeObj("functionTree");
							var nodes = zTree.getCheckedNodes(true);
							var nodeIds = [];
							for ( var i in nodes) {
								nodeIds.push(nodes[i].id);
							}
							url = "../../function/checkFunctions.do";
							$.post(url, {
								roleId : data.id,
								functionIds : nodeIds.toString()
							}, function(res) {
								if (res.result == true) {
									bootbox.alert("操作成功");
									grid1.reload();
								} else {
									bootbox.alert("操作失败");
								}
							});
						}
						//点击按钮事件
					});
					//生成树
					var setting = {
						check : {
							enable : true
						},
						data : {
							simpleData : {
								enable : true
							}
						}
					};
					modal.$body.HwTree({
						setting : setting,
						url : "../../function/functionTree.do?roleId=" + data.id,
						treeId : "functionTree"
					});
					modal.show();
				}
			} ],
		//第一行的工具栏
		tools : [
			//工具属性
			{
				text : "添加",
				color : "green",
				handle : function() {
					form.reset();
					form._form_action="../../role/add.do";
					$('#modal1').modal('show');
				}
			}, {
				text : "删除",
				color : "green",
				handle : function() {
					url = "../../role/deleteBatch.do";
					var checkedIds = grid1.currentCheckeds();
					if (checkedIds == "") {
						bootbox.alert("请选择要删除的选项");
						return;
					}
					bootbox.confirm("确定删除吗？",function(result) {
						if(result){
							$.post(url, {
								ids: checkedIds.toString()
							}, function (data) {
								if (data.result == true) {
									bootbox.alert("删除成功");
									grid1.reload();
								} else {
									bootbox.alert(data.err);
								}
							});
						}
					})
				}
			},
			{
				text : "刷新",
				cls : "btn-danger",//按钮样式
				handle : function() {
					grid1.reload({
						pageNum : 1
					});
				}
			}
		],
		//搜索栏定义
		search : {
			//搜索栏元素
			items : [ {
				type : "text",
				label : "角色名称",
				name : "roleName"
			} ]
		}
	};
	//生成grid代码
	var grid1 = box.$content.HwGrid(options);
	//form设置
	var formOpts = {
		id : "example_form",//表单id
		name : "example_form",//表单名
		method : "post",//表单method
		//action : "http://localhost:8080/hplus/jsp/form.jsp",//表单action
		action : "../../role/add.do",//表单action
		ajaxSubmit : true,//是否使用ajax提交表单
		ajaxSuccess : function(data) {
			if (data.result == true) {
				if (form._form_action == "../../role/add.do") {
					bootbox.alert("添加成功");
				} else {
					bootbox.alert("修改成功");
				}
				$('#modal1').modal('hide');
				grid1.reload();
				form._form_action = "../../role/add.do";
			} else {
				form.alertText("warning",data.err,2000);
			}
		}, //如果用ajax，则该项为必须
		submitText : "保存",//保存按钮的文本
		showReset : true,//是否显示重置按钮
		//resetText : "重置",//重置按钮文本
		//表单元素
		isValidate : true,//开启验证
		items : [
			{
			type : 'hidden',
			name : 'id',
			id : 'id'
		}, {
			type : 'text',
			name : 'roleName',
			id : 'roleName',
			label : '角色名称',
			span : '4',
			rule: {
				required : "true",
				rangelength:"[2,10]"
			},
			msg : {
				required : "角色名称不能为空",
				rangelength:"角色名称长度2~10位"
			}
		}, {
			type : 'radioGroup',
			name : 'state',
			id : 'state',
			label : '角色状态',
			span : '4',
			items : [ {
				name : 'state',
				value : '1',
				text : '启用'
			}, {
				name : 'state',
				value : '0',
				text : '关闭'
			} ],
			rule: {
				required : "true",
			},
			msg : {
				required : "角色状态不能为空",
			}
		}
		]
	};
	//生成弹出层
	var modal = $("body").HwModal({
		id : "modal1",
		title : "角色添加"
	});
	//生成表单并插入弹出层
	var form = modal.$body.HwForm(formOpts);

	function stateFormatData(index, content) {
		if (content.state == 1) {
			return "已启用";
		} else {
			return "已关闭";
		}
	}
</script>
</body>
</html>