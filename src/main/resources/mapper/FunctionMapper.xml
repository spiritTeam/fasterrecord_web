<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hitworth.framework.base.dao.FunctionDAO">
	<resultMap id="FunctionMap" type="Function">
		<result column="id" property="id" jdbcType="INTEGER" />
		<result column="parent_id" property="parentId"
			jdbcType="INTEGER" />
		<result column="type" property="type" jdbcType="INTEGER" />
		<result column="function_desc" property="desc"
			jdbcType="VARCHAR" />
		<result column="state" property="state" jdbcType="INTEGER" />
		<result column="title" property="title" jdbcType="VARCHAR" />
		<result column="path" property="path" jdbcType="VARCHAR" />
		<result column="name" property="name" jdbcType="VARCHAR" />
		<result column="redirect" property="redirect"
			jdbcType="VARCHAR" />
		<result column="component" property="component"
			jdbcType="VARCHAR" />
		<result column="hide_in_menu" property="hideInMenu"
			jdbcType="BOOLEAN" />
		<result column="not_cache" property="notCache"
			jdbcType="BOOLEAN" />
		<result column="icon" property="icon" jdbcType="VARCHAR" />

		<result column="insert_time" property="insertTime"
			javaType="java.sql.Timestamp" jdbcType="TIMESTAMP" />
	</resultMap>

	<!-- 新增权限 -->
	<insert id="insertFunction" parameterType="Function"
		keyProperty="id">
		insert into sys_function
		(

		parent_id,path,type,state,path,icon,function_desc,insert_time

		)
		values
		(

		#{parentId},#{path},#{type},#{state},#{path},#{icon},#{desc},#{insertTime}

		)

	</insert>

	<!--新增功能、角色关联 -->
	<insert id="insertFunctionRole" parameterType="int">
		insert
		into
		sys_function_role
		(

		function_id,role_id

		)
		values
		(

		#{functionId},#{roleId}

		)

	</insert>



	<!-- 删除功能列表 -->
	<delete id="deleteFunction" parameterType="int">
		delete from
		sys_function where id = #{id}
	</delete>

	<!-- 删除角色关联信息 -->
	<delete id="deleteFunctionRole" parameterType="int">
		delete from
		sys_function_role where function_id = #{functionId}
	</delete>

	<!-- 删除角色功能关联信息 -->
	<delete id="deleteRoleFunction" parameterType="int">
		delete from
		sys_function_role where role_id = #{roleId}
	</delete>


	<!-- 修改功能状态 -->
	<update id="updateState" parameterType="int" flushCache="true">
		update
		sys_function
		set state =
		#{state}
		where id =
		#{id}
	</update>

	<!-- 修改function信息 -->
	<update id="updateFunction" parameterType="Function"
		flushCache="true">
		update sys_function
		set parent_id = #{parentId},
		title = #{title},
		state = #{state},
		display = #{display},
		path = #{path},
		function_desc = #{desc}
		where id = #{id}
	</update>




	<!-- 加载function -->
	<select id="findFunction" parameterType="int"
		resultMap="FunctionMap">
		SELECT * from sys_function where id=#{id} and state=1
	</select>


	<!-- 根据角色查询权限 -->
	<select id="findAllEffectiveFunctionsbyRoleId"
		parameterType="int" resultMap="FunctionMap">
		SELECT
		DISTINCT(f.path),f.title
		from sys_role r, sys_function f,
		sys_function_role fr
		where r.id=fr.role_id and
		f.id=fr.function_id
		and
		f.state=1
		and
		r.id= #{roleId}
	</select>

	<!-- 查询当前用户的功能列表 -->
	<select id="findAllEffectiveFunctionsbyLoginName"
		parameterType="java.lang.String" resultMap="FunctionMap">
		SELECT
		f.id,
		f.parent_id,
		f.title,
		f.type,
		f.state,
		f.icon,
		f.function_desc,
		f.path,
		f. NAME,
		f.redirect,
		f.component,
		f.hide_in_menu,
		f.not_cache
		FROM
		sys_function f,
		sys_user u,
		sys_role r,
		sys_user_role ur,
		sys_function_role rf
		WHERE
		f.state = 1
		AND f.type = 1
		AND f.id = rf.function_id
		AND rf.role_id =
		r.id
		AND r.id = ur.role_id
		AND r.state = 1
		AND ur.user_id = u.id
		AND
		u.login_name = #{loginName}
		ORDER BY
		f.parent_id ,f.id
	</select>

	<!-- 所有功能权限列表 -->
	<select id="findFunctionList" resultMap="FunctionMap">
		SELECT * from
		sys_function
		order by id
	</select>

	<!-- 所有有效的功能权限列表 -->
	<select id="findEffectiveFunctinList" resultMap="FunctionMap">
		SELECT * from
		sys_function where state=1
		order by id
	</select>

	<!-- 查询当前action请求 -->
	<select id="findEffectiveFunctionsbyAction"
		parameterType="java.lang.String" resultType="java.lang.Integer">
		SELECT id from
		sys_function where state=1 and path like CONCAT(#{path},'%')
	</select>

	<!-- 根据角色获得相应的功能权限Id -->
	<select id="findFunctionTree" parameterType="int"
		resultType="int">
		SELECT function_id from sys_function_role where
		role_id=#{roleId}
		order by
		function_id
	</select>

	<!-- 用户条件查询 -->
	<select id="findFunctionListByQuery" parameterType="Function"
		resultMap="FunctionMap">
		SELECT * from sys_function where id!=0

		<if test="title!=null and title!='' ">
			and title like CONCAT(CONCAT('%',
			#{title}),'%')
		</if>
		<if test="path!= null and path!= '' ">
			and path like CONCAT(CONCAT('%', #{path}),'%')
		</if>

		order by id
	</select>

	<!-- 查询孩子节点 -->
	<select id="findFunctionbyParentId" parameterType="int"
		resultMap="FunctionMap">
		SELECT * from sys_function where parent_id=#{id}
	</select>

	<!-- 查询孩子节点 -->
	<select id="findFunctionbyParentIdAndFunctionName"
		parameterType="Function" resultMap="FunctionMap">
		SELECT * from sys_function where
		parent_id=#{parentId} and title=#{title}
	</select>




</mapper>