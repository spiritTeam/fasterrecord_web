<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hitworth.framework.base.dao.UserDAO">
	<resultMap id="UserMap" type="User">
		<result column="id" property="id" jdbcType="INTEGER" />
		<result column="login_name" property="loginName"
			jdbcType="VARCHAR" />
		<result column="password" property="password"
			jdbcType="VARCHAR" />
		<result column="display_name" property="displayName"
			jdbcType="VARCHAR" />
		<result column="type" property="type" jdbcType="VARCHAR" />
		<result column="state" property="state" jdbcType="INTEGER" />
		<result column="login_ip" property="loginIp" jdbcType="VARCHAR" />
		<result column="bind_ip" property="bindIp" jdbcType="VARCHAR" />
		<result column="ipband_flag" property="ipbandFlag"
			jdbcType="INTEGER" />
		<result column="try_times" property="tryTimes"
			jdbcType="INTEGER" />
		<result column="last_logintime" property="lastLogintime"
			javaType="java.sql.Timestamp" jdbcType="TIMESTAMP" />
		<result column="email" property="email" jdbcType="VARCHAR" />
		<result column="contact_phone" property="contactPhone"
			jdbcType="VARCHAR" />
		<result column="insert_time" property="insertTime"
			javaType="java.sql.Timestamp" jdbcType="TIMESTAMP" />
	</resultMap>

	<resultMap id="TreeNodeVOMap"
		type="com.hitworth.framework.base.vo.TreeNodeVO">
		<id column="id" property="id" jdbcType="INTEGER" />
		<result column="pid" property="pId" jdbcType="INTEGER" />
		<result column="name" property="name" jdbcType="VARCHAR" />
		<result column="checked" property="checked" jdbcType="BOOLEAN" />
	</resultMap>

	<resultMap id="energyLabelUserMap"
		type="com.energylabel.fastrecord.vo.EnergyLabelUser">
		<result column="id" property="fastRecordUserId"
			jdbcType="INTEGER" />
		<result column="el_user_id" property="energyLabeluserId"
			jdbcType="INTEGER" />
		<result column="el_eid" property="eid" jdbcType="INTEGER" />
		<result column="el_ename" property="ename" jdbcType="VARCHAR" />
		<result column="login_name" property="fastRecordLoginName"
			jdbcType="VARCHAR" />
		<result column="el_login_name" property="energyLabelLoginName"
			jdbcType="VARCHAR" />
		<result column="display_name" property="displayName"
			jdbcType="VARCHAR" />
		<result column="contact_phone" property="contactPhone"
			jdbcType="VARCHAR" />
	</resultMap>
	<!-- 新增用户 -->
	<insert id="insertUser" parameterType="User" keyProperty="id">
		insert
		into sys_user
		(

		login_name,password,display_name,type,state,email,contact_phone,insert_time

		)
		values
		(

		#{loginName},#{password},#{displayName},#{type},#{state},#{email},#{contactPhone},#{insertTime}

		)

	</insert>


	<!--新增用户、角色关联 -->
	<insert id="insertUserRole" parameterType="int">
		insert
		into
		sys_user_role
		(

		user_id,role_id

		)
		values
		(

		#{userId},#{roleId}

		)

	</insert>

	<!-- 删除一条用户信息 -->
	<delete id="deleteUser" parameterType="int">
		delete from sys_user where
		id = #{userId}
	</delete>

	<!-- 删除用户关联信息 -->
	<delete id="deleteUserRole" parameterType="int">
		delete from
		sys_user_role where user_id = #{userId}
	</delete>


	<!-- 修改密码 -->
	<update id="updatePassword" parameterType="User"
		flushCache="true">
		update sys_user
		set password =
		#{password}
		where login_name =
		#{loginName}
	</update>


	<!-- 修改用户信息 -->
	<update id="updateUser" parameterType="User" flushCache="true">
		update
		sys_user
		set password=#{password},
		display_name=#{displayName},
		type=#{type},
		email=#{email},
		contact_phone=#{contactPhone}
		where id =
		#{id}
	</update>

	<!-- 绑定能效系统用户信息 -->
	<update id="updateEnergyLabelUser"
		parameterType="com.hitworth.framework.base.vo.EnergyLabelUserVO"
		flushCache="true">
		update
		sys_user
		set
		el_user_id=#{energyLabeluserId},
		el_eid=#{eid},
		el_ename=#{ename},
		el_login_name=#{energyLabelLoginName}
		where login_name =
		#{fastRecordLoginName}
	</update>



	<!-- 修改用户状态 -->
	<update id="updateState" parameterType="int" flushCache="true">
		update
		sys_user
		set state =
		#{state}
		where id =
		#{id}
	</update>


	<!-- 用户查询 -->
	<select id="finduserList" resultMap="UserMap">
		select
		id,login_name,display_name,type,state,email,contact_phone
		from sys_user
		order by id
	</select>

	<!-- 用户条件查询 -->
	<select id="findUserListByQuery" parameterType="User"
		resultMap="UserMap">
		select
		id,login_name,display_name,type,state,email,contact_phone
		from
		sys_user

		<where>
			<if test="loginName!=null and loginName!='' ">
				login_name like CONCAT(CONCAT('%', #{loginName}),'%')
			</if>
			<if test="displayName!= null and displayName!= '' ">
				and display_name like CONCAT(CONCAT('%',
				#{displayName}),'%')
			</if>
		</where>

		order by id
	</select>

	<!-- 查询某个用户当前角色 -->
	<select id="findRolesByUserId" parameterType="int"
		resultType="int">
		select role_id from sys_user_role where user_id=#{userId}
	</select>


	<!-- 用户查询 -->
	<select id="findUserByLoginName"
		parameterType="java.lang.String" resultMap="UserMap">
		select * from sys_user
		where login_name=#{loginName}
	</select>

	<!-- 用户查询 -->
	<select id="findUserByEmail" parameterType="java.lang.String"
		resultMap="UserMap">
		select * from sys_user where email=#{email}
	</select>

	<select id="findUserById" parameterType="int"
		resultMap="UserMap">
		select * from sys_user where id=#{id}
	</select>

	<select id="getOrgsWithUserRelated" resultMap="TreeNodeVOMap"
		parameterType="int">
		SELECT t1.id,t1.pid,t1.name,
		(
		IF (
		(
		SELECT
		count(*)
		FROM
		sys_user_org t2
		WHERE
		t2.org_id = t1.id
		AND t2.user_id = #{userId}
		) = 1,
		TRUE,
		FALSE
		)
		) AS 'check'
		FROM
		sys_org t1
		ORDER BY
		t1.id ASC
	</select>

	<insert id="insertOrg">
		insert into sys_user_org (user_id, org_id)
		values
		(#{userId,jdbcType=INTEGER}, #{orgId,jdbcType=INTEGER} )
	</insert>

	<delete id="deleteOrg">
		delete from sys_user_org
		where user_id =
		#{userId,jdbcType=INTEGER}
	</delete>

	<select id="getEnergyLabelUser" parameterType="int"
		resultMap="energyLabelUserMap">
		select * from sys_user where id=#{fastRecordUserId}
	</select>

	<select id="getEnergyLabelUserByUserName" parameterType="string"
		resultMap="energyLabelUserMap">
		select * from sys_user where login_name=#{userName}
	</select>

</mapper>
